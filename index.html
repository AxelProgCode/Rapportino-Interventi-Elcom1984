<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapportino di Intervento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container" id="rapportino-content">
    <h1>Rapportino di Intervento Tecnico</h1>

    <div class="field-group">
        <label for="cliente">Cliente:</label>
        <input type="text" id="cliente" name="cliente" required>
    </div>

    <div class="field-group">
        <label for="tecnico">Tecnico:</label>
        <input type="text" id="tecnico" name="tecnico" required>
    </div>

    <div class="row">
        <div class="col field-group">
            <label for="data">Data:</label>
            <input type="date" id="data" name="data" required>
        </div>
        <div class="col field-group">
            <label for="ora_inizio">Ora Inizio:</label>
            <input type="time" id="ora_inizio" name="ora_inizio" required>
        </div>
        <div class="col field-group">
            <label for="ora_fine">Ora Fine:</label>
            <input type="time" id="ora_fine" name="ora_fine" required>
        </div>
    </div>

    <div class="field-group">
        <label for="materiale">Materiale Utilizzato:</label>
        <textarea id="materiale" name="materiale" rows="3"></textarea>
    </div>

    <div class="field-group">
        <label for="note">Note sull'Intervento:</label>
        <textarea id="note" name="note"></textarea>
    </div>

    <div class="field-group">
        <label>Foto:</label>
        <input type="file" id="foto" name="foto" accept="image/*" capture="camera" multiple>
        <div id="photo-preview">
            </div>
    </div>

    <div class="field-group">
        <label>Firma:</label>
        <canvas id="signature-area" width="400" height="150"></canvas>
        <div class="signature-controls">
            <button type="button" onclick="clearSignature()">Cancella Firma</button>
        </div>
    </div>

</div> 

<div class="button-group">
    <button type="button" class="button" onclick="generatePDF()">Salva PDF</button>
    <button type="button" class="button" id="invia-email-button" onclick="inviaEmail()">Invia Email</button>
</div>


<script>
    // --- Logica per la Firma ---

    const canvas = document.getElementById('signature-area');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // Impostazioni iniziali per il disegno
    ctx.strokeStyle = '#000000'; // Colore nero
    ctx.lineWidth = 2; // Spessore linea
    ctx.lineCap = 'round'; // Estremità della linea arrotondate

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        // Gestione di mouse (desktop) e touch (mobile)
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDrawing(e) {
        e.preventDefault(); // Evita lo scroll sul mobile
        isDrawing = true;
        const pos = getMousePos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getMousePos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    }

    function stopDrawing() {
        isDrawing = false;
        ctx.closePath();
    }

    // Event Listeners per Mouse e Touch
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    canvas.addEventListener('touchstart', startDrawing);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDrawing);

    function clearSignature() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- Logica per le Foto (Anteprima) ---

    const photoInput = document.getElementById('foto');
    const photoPreview = document.getElementById('photo-preview');
    
    // Variabile per tenere traccia dei Data URL delle immagini (necessario per il PDF)
    const photoDataUrls = []; 

    photoInput.addEventListener('change', function(e) {
        photoPreview.innerHTML = ''; // Pulisce le anteprime precedenti
        photoDataUrls.length = 0; // Pulisce l'array dei Data URL
        
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();

            reader.onload = function(e) {
                const imgDataUrl = e.target.result;
                photoDataUrls.push(imgDataUrl); // Salva il Data URL

                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                
                const img = document.createElement('img');
                img.src = imgDataUrl;
                
                photoItem.appendChild(img);
                photoPreview.appendChild(photoItem);
            };
            reader.readAsDataURL(file); // Converte il file in Data URL
        }
    });


    // --- Logica per la Generazione PDF ---
    
    // Funzione helper per ottenere il Data URL della firma
    function getSignatureImage() {
        const canvas = document.getElementById('signature-area');
        // Controlla se il canvas è vuoto (molto importante)
        const isEmpty = !ctx.getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0);
        return isEmpty ? null : canvas.toDataURL('image/png');
    }

    // Variabile globale per tenere traccia degli URL delle foto caricate (dal codice precedente)
    // Assicurati che l'array `photoDataUrls` sia disponibile e popolato.

    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' per portrait, 'mm' come unità, 'a4' come formato
        let y_position = 20; // Posizione Y iniziale (margine superiore)
        const line_height = 8;
        const margin = 15;
        const max_width = pdf.internal.pageSize.getWidth() - 2 * margin;

        // 1. Raccolta Dati
        const cliente = document.getElementById('cliente').value;
        const tecnico = document.getElementById('tecnico').value;
        const data = document.getElementById('data').value;
        const ora_inizio = document.getElementById('ora_inizio').value;
        const ora_fine = document.getElementById('ora_fine').value;
        const materiale = document.getElementById('materiale').value;
        const note = document.getElementById('note').value;
        const signatureImage = getSignatureImage();

        // 2. Intestazione
        pdf.setFontSize(18);
        pdf.setTextColor(0, 0, 128); // Blu scuro
        pdf.text('Rapportino di Intervento Tecnico', margin, y_position);
        y_position += line_height;
        pdf.setDrawColor(0, 0, 128);
        pdf.line(margin, y_position, pdf.internal.pageSize.getWidth() - margin, y_position); // Linea di separazione
        y_position += 5;
        
        // 3. Informazioni Principali (Cliente, Tecnico, Data)
        pdf.setFontSize(12);
        pdf.setTextColor(0, 0, 0); // Nero
        pdf.setFont('helvetica', 'bold');
        pdf.text('Cliente:', margin, y_position);
        pdf.setFont('helvetica', 'normal');
        pdf.text(cliente || 'N/D', margin + 30, y_position);

        y_position += line_height;
        pdf.setFont('helvetica', 'bold');
        pdf.text('Tecnico:', margin, y_position);
        pdf.setFont('helvetica', 'normal');
        pdf.text(tecnico || 'N/D', margin + 30, y_position);

        y_position += line_height;
        pdf.setFont('helvetica', 'bold');
        pdf.text('Data/Ora:', margin, y_position);
        pdf.setFont('helvetica', 'normal');
        pdf.text(`${data || 'N/D'} | Inizio: ${ora_inizio || 'N/D'} | Fine: ${ora_fine || 'N/D'}`, margin + 30, y_position);

        y_position += line_height * 1.5;

        // 4. Materiale Utilizzato
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Materiale Utilizzato:', margin, y_position);
        y_position += line_height * 0.8;
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        // Gestione del testo su più righe
        const splitMateriale = pdf.splitTextToSize(materiale || 'Nessun materiale specificato.', max_width);
        pdf.text(splitMateriale, margin, y_position);
        y_position += splitMateriale.length * line_height * 0.8; // Aggiorna posizione Y in base alle righe

        y_position += line_height;

        // 5. Note sull'Intervento
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Note sull\'Intervento:', margin, y_position);
        y_position += line_height * 0.8;
        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        
        // Gestione del testo su più righe
        const splitNote = pdf.splitTextToSize(note || 'Nessuna nota aggiunta.', max_width);
        pdf.text(splitNote, margin, y_position);
        y_position += splitNote.length * line_height * 0.8; // Aggiorna posizione Y

        y_position += line_height;

        // 6. Firma (come Immagine)
        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Firma:', margin, y_position);
        y_position += line_height * 0.5;

        if (signatureImage) {
            // Aggiunge l'immagine della firma
            const signatureWidth = 80; // Larghezza fissa (es. 80mm)
            const signatureHeight = 30; // Altezza fissa (es. 30mm)
            
            // Controlla se lo spazio rimanente è sufficiente, altrimenti aggiunge una nuova pagina
            if (y_position + signatureHeight + line_height > pdf.internal.pageSize.getHeight() - margin) {
                 pdf.addPage();
                 y_position = margin; // Reset Y sulla nuova pagina
            }
            
            pdf.addImage(signatureImage, 'PNG', margin, y_position, signatureWidth, signatureHeight);
            y_position += signatureHeight + line_height;
        } else {
            pdf.setFont('helvetica', 'normal');
            pdf.text('Firma non apposta.', margin, y_position + line_height * 0.5);
            y_position += line_height * 1.5;
        }

        // 7. Foto (come Immagini)
        if (photoDataUrls.length > 0) {
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Foto Allegate:', margin, y_position);
            y_position += line_height * 0.8;
            
            const photoWidth = 60; // Larghezza fissa per ogni foto
            const photoHeight = 45; // Altezza fissa per ogni foto
            let currentX = margin;

            for (const url of photoDataUrls) {
                // Controlla se la riga corrente è piena o se si è vicini al fondo
                if (currentX + photoWidth > pdf.internal.pageSize.getWidth() - margin) {
                    currentX = margin; // Vai a inizio riga
                    y_position += photoHeight + 5; // Nuova riga
                }

                // Controllo fine pagina
                if (y_position + photoHeight > pdf.internal.pageSize.getHeight() - margin) {
                    pdf.addPage();
                    y_position = margin; // Reset Y sulla nuova pagina
                    currentX = margin; // Reset X sulla nuova pagina
                }
                
                pdf.addImage(url, 'JPEG', currentX, y_position, photoWidth, photoHeight);
                currentX += photoWidth + 5; // Sposta X per la prossima foto
            }
            
             y_position += photoHeight + line_height; // Sposta Y dopo l'ultima riga di foto
        }

        // 8. Genera e Scarica
        const filename = `Rapportino_${cliente.replace(/\s/g, '_')}_${data}.pdf`;
        pdf.save(filename);
    }

    // --- Logica per l'Invio Email ---

    function inviaEmail() {
        // 1. Raccolta dei dati principali per l'oggetto e il corpo
        const cliente = document.getElementById('cliente').value;
        const tecnico = document.getElementById('tecnico').value;
        const data = document.getElementById('data').value;
        
        // Verifica che i campi necessari siano compilati
        if (!cliente || !tecnico || !data) {
            alert('Per preparare l\'email, compila i campi Cliente, Tecnico e Data.');
            return; 
        }

        // 2. Costruzione dell'Oggetto (Subject)
        const subject = encodeURIComponent(`Rapportino di Intervento | Cliente: ${cliente} | Data: ${data}`);

        // 3. Costruzione del Corpo (Body)
        let body = `Rapportino di intervento tecnico relativo a:\n\n`;
        body += `Cliente: ${cliente}\n`;
        body += `Tecnico Intervento: ${tecnico}\n`;
        body += `Data: ${data}\n\n`;
        body += `VEDI ALLEGATO`;

        // Uso di encodeURIComponent per formattare il testo per l'URL
        const encodedBody = encodeURIComponent(body);

        // 4. Creazione del link mailto:
        // Indirizzo email a cui inviare il rapportino
        const recipientEmail = 'info@elcomcongno.it';

        const mailtoLink = `mailto:${recipientEmail}?subject=${subject}&body=${encodedBody}`;

        // 5. Apertura del client di posta
        window.location.href = mailtoLink;
    }

</script>
</body>
</html>